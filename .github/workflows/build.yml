name: Build macOS

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        platform:
          - arch: arm64
            name: Apple Silicon
          - arch: amd64
            name: Intel

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: npm install
        working-directory: frontend

      # Import Developer ID cert (P12) into a temporary keychain for codesign
      - name: Import Developer ID certificate
        env:
          MACOS_CERT_P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          MACOS_CERT_P12_PASSWORD: ${{ secrets.MACOS_CERT_P12_PASSWORD }}
        run: |
          set -euo pipefail

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PW="$(openssl rand -hex 16)"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PW=$KEYCHAIN_PW" >> "$GITHUB_ENV"

          security create-keychain -p "$KEYCHAIN_PW" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PW" "$KEYCHAIN_PATH"

          # Make this keychain the only one searched to avoid picking the wrong identity
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          echo "$MACOS_CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$MACOS_CERT_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          # Required for non-interactive codesign on CI
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PW" "$KEYCHAIN_PATH"

          security find-identity -v -p codesigning

      - name: Build for ${{ matrix.platform.name }}
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.platform.arch }}
          CGO_ENABLED: 1
        run: |
          wails build -platform darwin/${{ matrix.platform.arch }}

      # Developer ID sign ONLY the .app (no DMG), then notarize the .app
      - name: Sign app (Developer ID)
        env:
          SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
        run: |
          set -euo pipefail

          APP_NAME="IAP Tunnel Manager"
          APP_PATH="build/bin/${APP_NAME}.app"

          # Ensure no quarantine attribute (shouldn't exist on CI, but harmless)
          xattr -cr "$APP_PATH" || true

          # Sign the bundle with hardened runtime
          codesign --force --options runtime --timestamp \
            --sign "$SIGNING_IDENTITY" \
            "$APP_PATH"

          # Verify signature
          codesign --verify --deep --strict --verbose=4 "$APP_PATH"

      # Notarize the .app by zipping it (Apple recommends submitting a zip for .app)
      - name: Notarize app (zip submit)
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          set -euo pipefail

          APP_NAME="IAP Tunnel Manager"
          APP_PATH="build/bin/${APP_NAME}.app"
          ZIP_PATH="$RUNNER_TEMP/${APP_NAME}.zip"

          # Create a proper zip for notarization
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

          # Write App Store Connect API key to disk
          mkdir -p "$RUNNER_TEMP/private_keys"
          KEY_PATH="$RUNNER_TEMP/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          echo "$ASC_PRIVATE_KEY_BASE64" | base64 --decode > "$KEY_PATH"

          # Submit for notarization
          xcrun notarytool submit "$ZIP_PATH" \
            --key "$KEY_PATH" \
            --key-id "$ASC_KEY_ID" \
            --issuer "$ASC_ISSUER_ID" \
            --wait

          # Staple the notarization ticket to the app bundle
          xcrun stapler staple "$APP_PATH"

          # Gatekeeper assessment
          spctl -a -vv "$APP_PATH"

      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: IAP-Tunnel-Manager-macOS-${{ matrix.platform.arch }}-app
          path: build/bin/*.app
          retention-days: 30

  universal:
    needs: build
    runs-on: macos-latest
    steps:
      - name: Download ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: IAP-Tunnel-Manager-macOS-arm64-app
          path: arm64

      - name: Download AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: IAP-Tunnel-Manager-macOS-amd64-app
          path: amd64

      - name: Import Developer ID certificate
        env:
          MACOS_CERT_P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          MACOS_CERT_P12_PASSWORD: ${{ secrets.MACOS_CERT_P12_PASSWORD }}
        run: |
          set -euo pipefail

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PW="$(openssl rand -hex 16)"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "KEYCHAIN_PW=$KEYCHAIN_PW" >> "$GITHUB_ENV"

          security create-keychain -p "$KEYCHAIN_PW" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PW" "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          echo "$MACOS_CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$MACOS_CERT_P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PW" "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning

      - name: Create Universal App
        run: |
          set -euo pipefail

          APP_NAME="IAP Tunnel Manager"

          cp -R "arm64/${APP_NAME}.app" "${APP_NAME}.app"

          lipo -create \
            "arm64/${APP_NAME}.app/Contents/MacOS/${APP_NAME}" \
            "amd64/${APP_NAME}.app/Contents/MacOS/${APP_NAME}" \
            -output "${APP_NAME}.app/Contents/MacOS/${APP_NAME}"

          file "${APP_NAME}.app/Contents/MacOS/${APP_NAME}"

      - name: Sign universal app (Developer ID)
        env:
          SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
        run: |
          set -euo pipefail
          APP_NAME="IAP Tunnel Manager"
          APP_PATH="${APP_NAME}.app"

          xattr -cr "$APP_PATH" || true

          codesign --force --options runtime --timestamp \
            --sign "$SIGNING_IDENTITY" \
            "$APP_PATH"

          codesign --verify --deep --strict --verbose=4 "$APP_PATH"

      - name: Notarize universal app (zip submit)
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          set -euo pipefail

          APP_NAME="IAP Tunnel Manager"
          APP_PATH="${APP_NAME}.app"
          ZIP_PATH="$RUNNER_TEMP/${APP_NAME}-universal.zip"

          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

          mkdir -p "$RUNNER_TEMP/private_keys"
          KEY_PATH="$RUNNER_TEMP/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          echo "$ASC_PRIVATE_KEY_BASE64" | base64 --decode > "$KEY_PATH"

          xcrun notarytool submit "$ZIP_PATH" \
            --key "$KEY_PATH" \
            --key-id "$ASC_KEY_ID" \
            --issuer "$ASC_ISSUER_ID" \
            --wait

          xcrun stapler staple "$APP_PATH"
          spctl -a -vv "$APP_PATH"

      - name: Upload Universal App
        uses: actions/upload-artifact@v4
        with:
          name: IAP-Tunnel-Manager-macOS-universal-app
          path: "*.app"
          retention-days: 30

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, universal]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.app/**
          draft: true
          generate_release_notes: true
